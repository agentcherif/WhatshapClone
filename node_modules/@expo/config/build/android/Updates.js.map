{"version":3,"file":"Updates.js","sourceRoot":"","sources":["../../src/android/Updates.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\n\nimport { ExpoConfig } from '../Config.types';\nimport { projectHasModule } from '../Modules';\nimport {\n  addMetaDataItemToMainApplication,\n  Document,\n  getMainApplication,\n  getMainApplicationMetaDataValue,\n  removeMetaDataItemFromMainApplication,\n} from './Manifest';\n\nexport enum Config {\n  ENABLED = 'expo.modules.updates.ENABLED',\n  CHECK_ON_LAUNCH = 'expo.modules.updates.EXPO_UPDATES_CHECK_ON_LAUNCH',\n  LAUNCH_WAIT_MS = 'expo.modules.updates.EXPO_UPDATES_LAUNCH_WAIT_MS',\n  SDK_VERSION = 'expo.modules.updates.EXPO_SDK_VERSION',\n  RUNTIME_VERSION = 'expo.modules.updates.EXPO_RUNTIME_VERSION',\n  UPDATE_URL = 'expo.modules.updates.EXPO_UPDATE_URL',\n}\n\nexport function getUpdateUrl(config: ExpoConfig, username: string | null): string | null {\n  const user = typeof config.owner === 'string' ? config.owner : username;\n  if (!user) {\n    return null;\n  }\n  return `https://exp.host/@${user}/${config.slug}`;\n}\n\nexport function getRuntimeVersion(config: ExpoConfig): string | null {\n  return typeof config.runtimeVersion === 'string' ? config.runtimeVersion : null;\n}\n\nexport function getSDKVersion(config: ExpoConfig): string | null {\n  return typeof config.sdkVersion === 'string' ? config.sdkVersion : null;\n}\n\nexport function getUpdatesEnabled(config: ExpoConfig): boolean {\n  return config.updates?.enabled !== false;\n}\n\nexport function getUpdatesTimeout(config: ExpoConfig): number {\n  return config.updates?.fallbackToCacheTimeout ?? 0;\n}\n\nexport function getUpdatesCheckOnLaunch(config: ExpoConfig): 'NEVER' | 'ALWAYS' {\n  if (config.updates?.checkAutomatically === 'ON_ERROR_RECOVERY') {\n    return 'NEVER';\n  } else if (config.updates?.checkAutomatically === 'ON_LOAD') {\n    return 'ALWAYS';\n  }\n  return 'ALWAYS';\n}\n\nexport async function setUpdatesConfig(\n  config: ExpoConfig,\n  manifestDocument: Document,\n  username: string | null\n): Promise<Document> {\n  const mainApplication = getMainApplication(manifestDocument);\n\n  addMetaDataItemToMainApplication(\n    mainApplication,\n    Config.ENABLED,\n    String(getUpdatesEnabled(config))\n  );\n  addMetaDataItemToMainApplication(\n    mainApplication,\n    Config.CHECK_ON_LAUNCH,\n    getUpdatesCheckOnLaunch(config)\n  );\n  addMetaDataItemToMainApplication(\n    mainApplication,\n    Config.LAUNCH_WAIT_MS,\n    String(getUpdatesTimeout(config))\n  );\n\n  const updateUrl = getUpdateUrl(config, username);\n  if (updateUrl) {\n    addMetaDataItemToMainApplication(mainApplication, Config.UPDATE_URL, updateUrl);\n  } else {\n    removeMetaDataItemFromMainApplication(mainApplication, Config.UPDATE_URL);\n  }\n\n  return setVersionsConfig(config, manifestDocument);\n}\n\nexport function setVersionsConfig(config: ExpoConfig, manifestDocument: Document): Document {\n  const mainApplication = getMainApplication(manifestDocument);\n\n  const runtimeVersion = getRuntimeVersion(config);\n  const sdkVersion = getSDKVersion(config);\n  if (runtimeVersion) {\n    removeMetaDataItemFromMainApplication(mainApplication, Config.SDK_VERSION);\n    addMetaDataItemToMainApplication(mainApplication, Config.RUNTIME_VERSION, runtimeVersion);\n  } else if (sdkVersion) {\n    removeMetaDataItemFromMainApplication(mainApplication, Config.RUNTIME_VERSION);\n    addMetaDataItemToMainApplication(mainApplication, Config.SDK_VERSION, sdkVersion);\n  } else {\n    removeMetaDataItemFromMainApplication(mainApplication, Config.RUNTIME_VERSION);\n    removeMetaDataItemFromMainApplication(mainApplication, Config.SDK_VERSION);\n  }\n\n  return manifestDocument;\n}\n\nexport function formatApplyLineForBuildGradle(projectDir: string, config: ExpoConfig): string {\n  const updatesGradleScriptPath = projectHasModule(\n    'expo-updates/scripts/create-manifest-android.gradle',\n    projectDir,\n    config\n  );\n\n  if (!updatesGradleScriptPath) {\n    throw new Error(\n      \"Could not find the build script for Android. This could happen in case of outdated 'node_modules'. Run 'npm install' to make sure that it's up-to-date.\"\n    );\n  }\n\n  return `apply from: ${JSON.stringify(\n    path.relative(path.join(projectDir, 'android', 'app'), updatesGradleScriptPath)\n  )}`;\n}\n\nexport function isBuildGradleConfigured(\n  buildGradleContent: string,\n  projectDir: string,\n  config: ExpoConfig\n): boolean {\n  const androidBuildScript = formatApplyLineForBuildGradle(projectDir, config);\n\n  return (\n    buildGradleContent\n      .split('\\n')\n      // Check for both single and double quotes\n      .some(line => line === androidBuildScript || line === androidBuildScript.replace(/\"/g, \"'\"))\n  );\n}\n\nexport function isMainApplicationMetaDataSet(manifest: Document): boolean {\n  const updateUrl = getMainApplicationMetaDataValue(manifest, Config.UPDATE_URL);\n  const runtimeVersion = getMainApplicationMetaDataValue(manifest, Config.RUNTIME_VERSION);\n  const sdkVersion = getMainApplicationMetaDataValue(manifest, Config.SDK_VERSION);\n\n  return Boolean(updateUrl && (sdkVersion || runtimeVersion));\n}\n\nexport function isMainApplicationMetaDataSynced(\n  config: ExpoConfig,\n  manifest: Document,\n  username: string | null\n): boolean {\n  return (\n    getUpdateUrl(config, username) ===\n      getMainApplicationMetaDataValue(manifest, Config.UPDATE_URL) &&\n    String(getUpdatesEnabled(config)) ===\n      getMainApplicationMetaDataValue(manifest, Config.ENABLED) &&\n    String(getUpdatesTimeout(config)) ===\n      getMainApplicationMetaDataValue(manifest, Config.LAUNCH_WAIT_MS) &&\n    getUpdatesCheckOnLaunch(config) ===\n      getMainApplicationMetaDataValue(manifest, Config.CHECK_ON_LAUNCH) &&\n    areVersionsSynced(config, manifest)\n  );\n}\n\nexport function areVersionsSynced(config: ExpoConfig, manifest: Document): boolean {\n  const expectedRuntimeVersion = getRuntimeVersion(config);\n  const expectedSdkVersion = getSDKVersion(config);\n  const currentRuntimeVersion = getMainApplicationMetaDataValue(manifest, Config.RUNTIME_VERSION);\n  const currentSdkVersion = getMainApplicationMetaDataValue(manifest, Config.SDK_VERSION);\n\n  return (\n    currentRuntimeVersion === expectedRuntimeVersion && currentSdkVersion === expectedSdkVersion\n  );\n}\n"]}